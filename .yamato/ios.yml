{% metadata_file .yamato/meta/branches.metafile %}
{% metadata_file .yamato/meta/targets.metafile %}
---
{%- for branch in branches -%}
{%- for targetPlatform in targetPlatforms.ios -%}
{%- for model in targetPlatform.agent.models -%}
{{ branch.safeName }}_Run_Test_With_iOS_Player_On_{{ targetPlatform.name | replace: ' ', '_' }}_{{ model }}:
  name: "[{{ branch.safeName }}] Run test with iOS player on {{ targetPlatform.name }} {{ model }}"
  variables:
    UNITY_BRANCH: {{ branch.name }}
  agent:
      # Running tests is fast, building it not requried, therefore flavor can be smaller. see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
      # Now we can use an 'expensive' type. 
      type: {{ targetPlatform.agent.type }}
      image: {{ targetPlatform.agent.image }}
      flavor: {{ targetPlatform.agent.flavor }}
      model: {{ model }}
  commands:
    - pip install performance-runner-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
    - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
    - unity-downloader-cli -u $UNITY_BRANCH -p editor -c editor -c iOS --wait --fast
    - performance-runner-cli --version=editor --project=. --test-id=urp-rendering-examples --platform=iOS --run-count=5
  artifacts:
    logs:
        paths:
          - "build/test-results/**"
{%- endfor -%}
{%- endfor -%}
{%- endfor -%}
