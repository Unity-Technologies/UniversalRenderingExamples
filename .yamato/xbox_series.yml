{% metadata_file .yamato/meta/branches.metafile %}
{% metadata_file .yamato/meta/targets.metafile %}
---
{%- for branch in branches -%}
{%- for targetPlatform in targetPlatforms.gamecorescarlett -%}
{{ branch.safeName }}_Run_Test_With_{{ targetPlatform.name | replace: ' ', '_' }}_Player:
  name: "[{{ branch.safeName }}] Run test with {{ targetPlatform.name }} player"
  variables:
    UNITY_BRANCH: {{ branch.name }}
  agent:
      # Running tests is fast, building it not requried, therefore flavor can be smaller. see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
      # Now we can use an 'expensive' type. 
      type: {{ targetPlatform.agent.type }}
      image: {{ targetPlatform.agent.image }}
      flavor: {{ targetPlatform.agent.flavor }}
  commands:
    - gsudo NetSh Advfirewall set allprofiles state off
    - '"%GameDK%/bin/xbconnect" /WS %BOKKEN_DEVICE_IP%'
    - git clone --filter=blob:none --sparse --no-checkout --depth 1 -v --branch {{ branch.name }} "https://github.cds.internal.unity3d.com/unity/unity.git"
    - cd unity && git sparse-checkout init --cone && git sparse-checkout set Platforms && git checkout {{ branch.name }}
    - gsudo xcopy unity\Platforms\GameCore\Packages\com.unity.render-pipelines.gamecore .\Packages\com.unity.render-pipelines.gamecore\ /O /X /E /H /K
    - pip install performance-runner-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
    - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
    - unity-downloader-cli -u %UNITY_BRANCH% -p editor -c GameCoreScarlett -c editor --wait --fast
    - performance-runner-cli --version=editor --project=. --test-id=tech-partnerships-urp-rendering-examples --platform=GameCoreScarlett --run-count=5
  artifacts:
    logs:
        paths:
          - "build/test-results/**"
{%- endfor -%}
{%- endfor -%}
